<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>myFit</title>
<style>
  :root{
    --bg:#0b0b0c;
    --card:#141416;
    --card2:#101012;
    --muted:#9aa0a6;
    --text:#ffffff;
    --accent:#00c896;
    --danger:#ff453a;
    --line:#242428;
    --chip:#0f0f12;
    --water:#3aa0ff;
    --warn:#ffcc00;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
  }
  .wrap{
    max-width: 430px;
    margin: 0 auto;
    padding: 14px 14px 90px 14px;
  }

  /* Header */
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; margin-bottom:10px;
  }
  .brand{
    display:flex; align-items:center; gap:10px;
    font-size:22px; font-weight:1000;
  }
  .logo{
    width:28px; height:28px; border-radius:8px;
    background:var(--card2);
    border:1px solid var(--line);
    object-fit:cover;
  }
  .titleCenter{
    position:absolute;
    left:0; right:0;
    text-align:center;
    pointer-events:none;
    font-weight:1000;
    font-size:16px;
    margin-top:2px;
    color:rgba(255,255,255,0.92);
  }
  .iconbtn{
    width:40px; height:40px;
    border-radius:12px;
    border:1px solid var(--line);
    background:var(--chip);
    color:var(--text);
    font-size:16px;
    display:flex; align-items:center; justify-content:center;
  }
  .topbarLeft, .topbarRight{ display:flex; align-items:center; gap:8px; z-index:1; }
  .topbarWrap{ position:relative; }

  /* Units toggle */
  .seg{
    display:inline-flex; border:1px solid var(--line);
    border-radius:999px; overflow:hidden; background:var(--card2);
  }
  .seg button{
    border:none; padding:8px 10px; color:var(--muted);
    background:transparent; font-size:12px; font-weight:900;
  }
  .seg button.active{ color:#0b0b0c; background:var(--accent); }

  .grid{ display:grid; gap:12px; }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    padding:14px;
  }
  h2{ margin:0 0 8px 0; font-size:16px; }
  .sub{ color:var(--muted); font-size:13px; margin-top:4px; line-height:1.3; }
  .divider{ height:1px; background:var(--line); margin:12px 0; }

  input, select, textarea{
    width:100%;
    background:var(--chip); color:var(--text);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px 12px;
    font-size:15px;
    outline:none;
  }
  textarea{ min-height:92px; resize:vertical; }

  .row{ display:flex; gap:10px; align-items:center; }
  .row > *{ flex:1; }

  .btn{
    width:100%; border:none;
    border-radius:12px;
    padding:12px 14px;
    font-size:15px;
    background:var(--accent);
    color:#0b0b0c;
    font-weight:1000;
  }
  .btn.secondary{ background:#2b2b2f; color:var(--text); font-weight:900; }
  .btn.danger{ background:var(--danger); color:#0b0b0c; font-weight:1000; }
  .btn.small{ padding:10px 12px; font-size:14px; border-radius:10px; }
  .btn.ghost{ background:transparent; border:1px solid var(--line); color:var(--text); }
  .btn.warn{ background:var(--warn); color:#0b0b0c; font-weight:1000; }

  /* Hero */
  .hero{
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border:1px solid var(--line);
    border-radius:18px;
    padding:16px;
  }
  .heroTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
  .heroTitle{ font-size:18px; font-weight:1000; margin:0; }
  .heroMeta{ color:var(--muted); font-size:13px; font-weight:800; margin-top:6px; }
  .progress{
    width:100%; height:10px; border-radius:999px;
    background:var(--chip); border:1px solid var(--line); overflow:hidden;
    margin-top:12px;
  }
  .progress > div{ height:100%; background:var(--accent); width:0%; }
  .heroStats{ display:flex; justify-content:space-between; gap:12px; margin-top:12px; }
  .stat .label{ color:var(--muted); font-size:12px; font-weight:900; }
  .stat .value{ font-size:18px; font-weight:1000; margin-top:2px; }

  /* Week strip */
  .weekStrip{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:8px;
    margin-top:12px;
  }
  .pill{
    background:var(--chip);
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 0;
    text-align:center;
  }
  .pill .dow{ color:var(--muted); font-size:11px; font-weight:900; }
  .pill .day{ font-size:14px; font-weight:1000; margin-top:4px; }
  .pill.sel{
    border-color:var(--accent);
    box-shadow:0 0 0 2px rgba(0,200,150,0.15) inset;
  }

  /* Action icon row */
  .actions{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:10px;
    margin-top:12px;
  }
  .actionBtn{
    background:var(--chip);
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px 8px;
    text-align:center;
    color:var(--text);
  }
  .actionIcon{
    width:40px; height:40px;
    border-radius:14px;
    margin:0 auto 8px auto;
    background:rgba(255,255,255,0.06);
    border:1px solid var(--line);
    display:flex; align-items:center; justify-content:center;
    font-size:18px;
  }
  .actionLabel{
    font-size:11px;
    color:var(--muted);
    font-weight:1000;
    line-height:1.1;
  }

  /* Collapsible */
  details{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    padding:0;
    overflow:hidden;
  }
  summary{
    list-style:none;
    cursor:pointer;
    padding:14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  summary::-webkit-details-marker{ display:none; }
  .sumTitle{ font-weight:1000; }
  .sumRight{ color:var(--muted); font-weight:900; font-size:13px; }
  .detailBody{ padding:0 14px 14px 14px; }

  /* Water glasses */
  .glasses{ display:flex; gap:10px; flex-wrap:wrap; }
  .glasswrap{ display:flex; flex-direction:column; align-items:center; }
  .glass{
    width:72px; height:92px;
    border:2px solid #3a3a40;
    border-radius:14px 14px 18px 18px;
    position:relative; overflow:hidden;
    background:transparent;
  }
  .glass .fill{
    position:absolute; left:0; right:0; bottom:0;
    height:0%;
    background:linear-gradient(180deg, rgba(58,160,255,0.9), rgba(58,160,255,0.5));
    transition:height .18s ease;
  }
  .glass .check{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    font-size:28px; font-weight:1000;
    color:rgba(0,0,0,0);
    transition:color .18s ease;
  }
  .glass.done .fill{ height:68%; }
  .glass.done .check{ color:rgba(0,0,0,0.45); }
  .glasslabel{ margin-top:6px; font-size:12px; color:var(--muted); font-weight:900; }

  /* Workout list */
  .witem{
    display:flex; gap:10px; align-items:flex-start;
    padding:12px 0; border-bottom:1px solid var(--line);
  }
  .witem:last-child{ border-bottom:none; }
  .wcheck{
    width:22px; height:22px; border-radius:6px;
    border:1px solid var(--line); background:var(--chip);
    display:flex; align-items:center; justify-content:center;
    color:#0b0b0c; font-weight:1000; flex:0 0 auto;
    margin-top:2px;
  }
  .wcheck.done{ background:var(--accent); border-color:transparent; }
  .wname{ font-weight:1000; }
  .wmeta{ color:var(--muted); font-size:12px; margin-top:3px; font-weight:900; display:flex; gap:8px; flex-wrap:wrap; }
  .chip{
    background:rgba(255,255,255,0.06);
    border:1px solid var(--line);
    color:rgba(255,255,255,0.9);
    border-radius:999px;
    padding:4px 8px;
    font-size:11px;
    font-weight:1000;
  }
  .rightBtns{ margin-left:auto; display:flex; gap:8px; }
  .miniBtn{
    border:1px solid var(--line);
    background:var(--chip);
    color:var(--text);
    border-radius:12px;
    padding:8px 10px;
    font-weight:1000;
    font-size:12px;
    white-space:nowrap;
  }
  .miniBtn.primary{
    background:rgba(0,200,150,0.18);
    border-color:rgba(0,200,150,0.35);
  }
  .nextHint{
    color:rgba(0,200,150,0.9);
    font-size:12px;
    font-weight:1000;
    margin-top:6px;
  }

  /* Plan grid */
  .weekGrid{
    display:grid; grid-template-columns:repeat(7,1fr);
    gap:8px;
  }
  .dayBox{
    background:var(--chip); border:1px solid var(--line);
    border-radius:12px; padding:10px; min-height:78px;
    display:flex; flex-direction:column; gap:6px;
  }
  .dayBox .dow{ color:var(--muted); font-size:12px; font-weight:900; }
  .dayBox .what{ font-size:12px; font-weight:1000; line-height:1.2; }
  .dayBox.sel{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(0,200,150,0.15) inset; }

  /* Bottom nav */
  .bottomNav{
    position:fixed;
    left:0; right:0; bottom:0;
    padding:10px 14px calc(10px + env(safe-area-inset-bottom)) 14px;
    background:rgba(11,11,12,0.92);
    backdrop-filter: blur(10px);
    border-top:1px solid var(--line);
  }
  .bottomNav .bar{
    max-width:430px;
    margin:0 auto;
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:8px;
  }
  .navItem{
    border:1px solid var(--line);
    background:var(--chip);
    border-radius:14px;
    padding:10px 8px;
    text-align:center;
    color:var(--muted);
    font-weight:1000;
    font-size:12px;
  }
  .navItem.active{
    background:var(--accent);
    color:#0b0b0c;
    border-color:transparent;
  }

  /* Modal */
  .modalBackdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.55);
    display:none;
    align-items:flex-end;
    justify-content:center;
    padding:14px;
    z-index:1000;
  }
  .modalBackdrop.show{ display:flex; }
  .sheet{
    width:100%;
    max-width:430px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:18px;
    overflow:hidden;
  }
  .sheetHeader{
    padding:12px 14px;
    display:flex; align-items:center; justify-content:space-between;
    border-bottom:1px solid var(--line);
  }
  .sheetTitle{ font-weight:1000; }
  .sheetBody{ padding:14px; max-height:72vh; overflow:auto; }
  .sheetFooter{
    padding:12px 14px;
    border-top:1px solid var(--line);
    display:flex; gap:10px;
  }
  .sheetFooter .btn{ flex:1; }

  .seg2{
    display:flex;
    border:1px solid var(--line);
    background:var(--chip);
    border-radius:14px;
    overflow:hidden;
  }
  .seg2 button{
    flex:1;
    border:none;
    padding:10px 10px;
    background:transparent;
    color:var(--muted);
    font-weight:1000;
  }
  .seg2 button.active{
    background:rgba(0,200,150,0.16);
    color:var(--text);
  }

  .list{
    display:grid; gap:10px;
  }
  .listItem{
    background:var(--chip);
    border:1px solid var(--line);
    border-radius:14px;
    padding:12px;
  }
  .listItemTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
  .listItemName{ font-weight:1000; }
  .listItemMeta{ margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
  .tiny{ font-size:12px; color:var(--muted); font-weight:900; }

  .hidden{ display:none !important; }
</style>
</head>

<body>
<div class="wrap">

  <!-- Header (Today-style header always; title changes per tab) -->
  <div class="topbarWrap">
    <div class="topbar">
      <div class="topbarLeft">
        <button class="iconbtn" onclick="openProfileHint()" title="Profile">üë§</button>
        <div class="brand">
          <img src="./logo.png" class="logo" alt="myFit logo" onerror="this.style.display='none'">
          <span class="hidden" id="brandText">myFit</span>
        </div>
      </div>

      <div class="titleCenter" id="topTitle">Today</div>

      <div class="topbarRight">
        <div class="seg" aria-label="Units toggle">
          <button id="uImp" class="active" onclick="setUnits('imperial')">Imp</button>
          <button id="uMet" onclick="setUnits('metric')">Met</button>
        </div>
        <button class="iconbtn" onclick="openQuickHelp()" title="Help">‚ùì</button>
      </div>
    </div>
  </div>

  <!-- ONBOARDING -->
  <div id="onboarding" class="card" style="margin-top:12px;">
    <h2>Initial Questionnaire ‚úçÔ∏è</h2>
    <div class="sub">Build your plan once. You can change it later.</div>
    <div class="divider"></div>

    <div id="step1">
      <div class="row">
        <select id="goalType">
          <option value="fat">Lose Fat</option>
          <option value="muscle">Build Muscle</option>
          <option value="hybrid" selected>Hybrid / Functional</option>
          <option value="endurance">Endurance Focus</option>
        </select>
        <select id="exp">
          <option value="beginner" selected>Beginner</option>
          <option value="intermediate">Intermediate</option>
          <option value="advanced">Advanced</option>
        </select>
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="height" type="number" placeholder="Height (inches or cm)">
        <input id="weight" type="number" placeholder="Weight (lbs or kg)">
      </div>
      <div class="row" style="margin-top:10px;">
        <select id="daysPerWeek">
          <option value="3">3 days / week</option>
          <option value="4" selected>4 days / week</option>
          <option value="5">5 days / week</option>
          <option value="6">6 days / week</option>
        </select>
        <select id="timePerSession">
          <option value="25">~25 min</option>
          <option value="40" selected>~40 min</option>
          <option value="55">~55 min</option>
          <option value="70">~70 min</option>
        </select>
      </div>
      <button class="btn" onclick="nextStep(2)">Next ‚ûú</button>
    </div>

    <div id="step2" class="hidden">
      <div class="row">
        <select id="mobility">
          <option value="low">Mobility: low</option>
          <option value="mid" selected>Mobility: moderate</option>
          <option value="high">Mobility: high priority</option>
        </select>
        <select id="cardioPref">
          <option value="none">Cardio: minimal</option>
          <option value="some" selected>Cardio: some</option>
          <option value="love">Cardio: I like it</option>
        </select>
      </div>
      <div class="row" style="margin-top:10px;">
        <select id="alcohol">
          <option value="0">Alcohol: none</option>
          <option value="1" selected>Alcohol: 1‚Äì2 days/week</option>
          <option value="3">Alcohol: 3‚Äì4 days/week</option>
          <option value="5">Alcohol: 5+ days/week</option>
        </select>
        <select id="lifestyle">
          <option value="sedentary">Lifestyle: sedentary</option>
          <option value="light" selected>Lifestyle: lightly active</option>
          <option value="active">Lifestyle: active</option>
        </select>
      </div>
      <input id="limitations" style="margin-top:10px;" placeholder="Injuries/limits (knee/back/etc) ‚Äî optional" />
      <div class="divider"></div>
      <button class="btn" onclick="finishOnboarding()">Generate myFit Plan üöÄ</button>
      <button class="btn secondary" onclick="nextStep(1)" style="margin-top:8px;">‚¨Ö Back</button>
      <div class="divider"></div>
      <div class="sub">Private browsing wipes local storage. We‚Äôll add cloud later.</div>
    </div>
  </div>

  <!-- TODAY -->
  <div id="view-today" class="grid hidden" style="margin-top:12px;">

    <div class="hero">
      <div class="heroTop">
        <div>
          <div class="heroTitle" id="heroName">Your Plan</div>
          <div class="heroMeta" id="heroMeta">‚Äî</div>
        </div>
        <button class="iconbtn" onclick="showTab('settings')" title="Settings">‚öôÔ∏è</button>
      </div>

      <div class="progress"><div id="heroBar"></div></div>

      <div class="heroStats">
        <div class="stat">
          <div class="label">Progress complete</div>
          <div class="value" id="heroDone">0/0</div>
        </div>
        <div class="stat" style="text-align:right">
          <div class="label">Adherence</div>
          <div class="value" id="heroAdh">0%</div>
        </div>
      </div>

      <div class="weekStrip" id="weekStrip"></div>

      <div class="actions">
        <button class="actionBtn" onclick="openPlanOverview()">
          <div class="actionIcon">üìã</div>
          <div class="actionLabel">Plan<br>Overview</div>
        </button>
        <button class="actionBtn" onclick="openAudible()">
          <div class="actionIcon">üîÅ</div>
          <div class="actionLabel">Rearrange</div>
        </button>
        <button class="actionBtn" onclick="connectedAppsHint()">
          <div class="actionIcon">üîó</div>
          <div class="actionLabel">Connected<br>Apps</div>
        </button>
        <button class="actionBtn" onclick="showTab('goal')">
          <div class="actionIcon">üéØ</div>
          <div class="actionLabel">Manage<br>Plan</div>
        </button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:10px;">
        <button class="btn secondary" onclick="shiftSelected(-1)">‚¨Ö Prev</button>
        <button class="btn secondary" onclick="jumpToToday()">Today üìç</button>
        <button class="btn secondary" onclick="shiftSelected(1)">Next ‚û°</button>
      </div>
      <div class="divider"></div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="font-weight:1000;" id="selDateChip">‚Äî</div>
        <button class="miniBtn primary" onclick="analyzeDay()">Analyze üß†</button>
      </div>
      <div class="sub" id="analysisOut" style="margin-top:10px;">‚Äî</div>
    </div>

    <details open id="waterDetails">
      <summary>
        <div class="sumTitle">Water Intake üíß</div>
        <div class="sumRight" id="waterSummary">‚Äî</div>
      </summary>
      <div class="detailBody">
        <div class="sub" id="waterTargetText">‚Äî</div>
        <div class="divider"></div>
        <div class="glasses" id="glasses"></div>
        <div class="divider"></div>
        <button class="btn secondary" onclick="resetWaterSelected()">Reset this day</button>
      </div>
    </details>

    <details open id="workoutDetails">
      <summary>
        <div class="sumTitle">Today‚Äôs Workout üèãÔ∏è</div>
        <div class="sumRight" id="workoutSummary">‚Äî</div>
      </summary>
      <div class="detailBody">
        <div class="sub" id="dayTitle">‚Äî</div>
        <div class="divider"></div>
        <div id="workoutList"></div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn secondary" onclick="openAudible()">Make an Audible üéß</button>
          <button class="btn" onclick="completeSelectedWorkout()">Complete ‚úÖ</button>
        </div>
      </div>
    </details>

  </div>

  <!-- PLAN -->
  <div id="view-plan" class="grid hidden" style="margin-top:12px;">
    <div class="card">
      <h2>Weekly Plan üìÖ</h2>
      <div class="sub">Tap a day to jump to it.</div>
      <div class="divider"></div>
      <div class="weekGrid" id="weekGrid"></div>
    </div>
    <div class="card">
      <h2>Weekly Summary üìà</h2>
      <div class="sub" id="weeklySummary">‚Äî</div>
    </div>
  </div>

  <!-- GOAL -->
  <div id="view-goal" class="grid hidden" style="margin-top:12px;">
    <div class="card">
      <h2>Goal / Progress üéØ</h2>
      <div class="sub" id="goalText">‚Äî</div>
      <div class="divider"></div>
      <button class="btn secondary" onclick="openGoalChange()">Change goal ‚úçÔ∏è</button>
    </div>

    <div id="goalChange" class="card hidden">
      <h2>Change Goal ‚úçÔ∏è</h2>
      <div class="sub">Rebuilds the week (keeps your logs).</div>
      <div class="divider"></div>
      <select id="newGoalType">
        <option value="fat">Lose Fat</option>
        <option value="muscle">Build Muscle</option>
        <option value="hybrid">Hybrid / Functional</option>
        <option value="endurance">Endurance Focus</option>
      </select>
      <div class="row" style="margin-top:10px;">
        <select id="newDays">
          <option value="3">3 days / week</option>
          <option value="4" selected>4 days / week</option>
          <option value="5">5 days / week</option>
          <option value="6">6 days / week</option>
        </select>
        <select id="newTime">
          <option value="25">~25 min</option>
          <option value="40" selected>~40 min</option>
          <option value="55">~55 min</option>
          <option value="70">~70 min</option>
        </select>
      </div>
      <div class="divider"></div>
      <button class="btn" onclick="applyGoalChange()">Apply ‚úÖ</button>
      <button class="btn secondary" onclick="closeGoalChange()" style="margin-top:8px;">Cancel</button>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="view-settings" class="grid hidden" style="margin-top:12px;">
    <div class="card">
      <h2>Body Metrics ‚öñÔ∏è</h2>
      <div class="sub">Optional daily weight entry.</div>
      <div class="divider"></div>
      <div class="row">
        <input id="setWeight" type="number" placeholder="Current weight (lbs or kg)">
        <button class="btn small" style="flex:0 0 auto" onclick="saveWeight()">Save</button>
      </div>
      <div class="sub" id="weightSavedText" style="margin-top:10px;">‚Äî</div>
    </div>

    <div class="card">
      <h2>Export / Import üß≥</h2>
      <div class="sub">Use if private browsing wipes your data.</div>
      <div class="divider"></div>
      <button class="btn secondary" onclick="exportState()">Export myFit data</button>
      <textarea id="exportBox" class="hidden" readonly></textarea>
      <div class="divider"></div>
      <textarea id="importBox" placeholder="Paste exported JSON here to restore‚Ä¶"></textarea>
      <button class="btn" onclick="importState()">Import</button>
      <div class="divider"></div>
      <button class="btn danger" onclick="wipeAll()">Wipe all data</button>
    </div>
  </div>

</div>

<!-- Bottom nav -->
<div class="bottomNav">
  <div class="bar">
    <button class="navItem active" id="nav-today" onclick="showTab('today')">Today</button>
    <button class="navItem" id="nav-plan" onclick="showTab('plan')">Plan</button>
    <button class="navItem" id="nav-goal" onclick="showTab('goal')">Progress</button>
    <button class="navItem" id="nav-settings" onclick="showTab('settings')">Settings</button>
  </div>
</div>

<!-- Audible Modal -->
<div class="modalBackdrop" id="audibleModal" onclick="closeModalOnBackdrop(event,'audibleModal')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheetHeader">
      <div class="sheetTitle">Make an Audible üéß</div>
      <button class="iconbtn" onclick="closeAudible()">‚úï</button>
    </div>
    <div class="sheetBody">
      <div class="seg2" style="margin-bottom:12px;">
        <button id="audMode0" class="active" onclick="setAudMode(0)">Swap</button>
        <button id="audMode1" onclick="setAudMode(1)">Rest</button>
        <button id="audMode2" onclick="setAudMode(2)">Replace</button>
      </div>

      <!-- Swap -->
      <div id="audSwap">
        <div class="sub">Pick an exercise to replace. You‚Äôll see replacements ranked by <b>primary muscle + movement pattern</b>.</div>
        <div class="divider"></div>

        <div class="tiny">1) Replace which exercise?</div>
        <select id="swapFrom" onchange="renderSwapCandidates()" style="margin-top:8px;"></select>

        <div class="divider"></div>

        <div class="row" style="align-items:flex-start;">
          <div>
            <div class="tiny">Target</div>
            <div id="swapFromMeta" class="wmeta" style="margin-top:6px;"></div>
          </div>
          <div style="text-align:right;">
            <div class="tiny">Accessory alternatives</div>
            <button class="miniBtn" id="accToggle" onclick="toggleAccessory()">Off</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="tiny">2) Choose replacement</div>
        <div class="list" id="swapCandidates" style="margin-top:8px;"></div>
      </div>

      <!-- Rest -->
      <div id="audRest" class="hidden">
        <div class="sub">Convert this day to rest. Optionally rebalance the week so workout count stays consistent.</div>
        <div class="divider"></div>
        <button class="btn secondary" onclick="setDayRest()">Make this day Rest üòå</button>
        <div class="divider"></div>
        <button class="btn" onclick="setDayRest(true)">Make Rest + Rebalance week ‚úÖ</button>
      </div>

      <!-- Replace -->
      <div id="audReplace" class="hidden">
        <div class="sub">Replace today‚Äôs workout with a new focus built from your exercise library.</div>
        <div class="divider"></div>
        <div class="row">
          <button class="btn secondary" onclick="replaceDayFocus('upper')">Upper</button>
          <button class="btn secondary" onclick="replaceDayFocus('lower')">Lower</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" onclick="replaceDayFocus('full')">Full</button>
          <button class="btn secondary" onclick="replaceDayFocus('cardio')">Cardio</button>
        </div>
        <button class="btn secondary" style="margin-top:10px;" onclick="replaceDayFocus('mobility')">Mobility</button>
        <div class="divider"></div>
        <button class="btn" onclick="replaceDayFocus(state.profile.goalType, true)">Replace + Rebalance week ‚úÖ</button>
      </div>

      <div class="divider"></div>
      <div class="sub" id="audibleOut">‚Äî</div>
    </div>
    <div class="sheetFooter">
      <button class="btn secondary" onclick="closeAudible()">Close</button>
    </div>
  </div>
</div>

<!-- Set Logger Modal -->
<div class="modalBackdrop" id="setModal" onclick="closeModalOnBackdrop(event,'setModal')">
  <div class="sheet" onclick="event.stopPropagation()">
    <div class="sheetHeader">
      <div class="sheetTitle" id="setTitle">Log Sets</div>
      <button class="iconbtn" onclick="closeSetModal()">‚úï</button>
    </div>
    <div class="sheetBody">
      <div class="sub" id="setMeta">‚Äî</div>
      <div class="divider"></div>
      <div id="setRows"></div>
      <div class="divider"></div>
      <div class="row">
        <button class="btn secondary" onclick="addSetRow()">+ Add set</button>
        <button class="btn secondary" onclick="removeSetRow()">‚Äì Remove</button>
      </div>
      <div class="divider"></div>
      <div class="sub" id="setRec">‚Äî</div>
    </div>
    <div class="sheetFooter">
      <button class="btn secondary" onclick="closeSetModal()">Cancel</button>
      <button class="btn" onclick="saveSetLog()">Save ‚úÖ</button>
    </div>
  </div>
</div>

<script>
/* ------------------------- Constants ------------------------- */
const DOW = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const MUSCLE_LABEL = {
  quads:"Quads", glutes:"Glutes", hamstrings:"Hamstrings", calves:"Calves",
  chest:"Chest", back:"Back", shoulders:"Shoulders",
  biceps:"Biceps", triceps:"Triceps", core:"Core",
  cardio:"Cardio", mobility:"Mobility"
};
const PATTERN_LABEL = { squat:"Squat", hinge:"Hinge", push:"Push", pull:"Pull", carry:"Carry", core:"Core", cardio:"Cardio", mobility:"Mobility" };

/* ------------------------- Exercise Library (~110) ------------------------- */
/* Each exercise: id, name, primaryMuscle, secondaryMuscles[], movementPattern, equipment[], category(compound|accessory|core|cardio|mobility) */
const EX = [
  // QUADS
  ex("back_squat","Back Squat","quads",["glutes"],"squat",["barbell","rack"],"compound"),
  ex("front_squat","Front Squat","quads",["core","glutes"],"squat",["barbell","rack"],"compound"),
  ex("goblet_squat","Goblet Squat","quads",["glutes"],"squat",["dumbbell"],"compound"),
  ex("smith_squat","Smith Machine Squat","quads",["glutes"],"squat",["machine"],"compound"),
  ex("hack_squat","Hack Squat (Machine)","quads",["glutes"],"squat",["machine"],"compound"),
  ex("leg_press_plate","Leg Press (Plate Loaded)","quads",["glutes"],"squat",["machine"],"compound"),
  ex("leg_press_select","Leg Press (Selectorized)","quads",["glutes"],"squat",["machine"],"compound"),
  ex("bulgarian_split","Bulgarian Split Squat","quads",["glutes"],"squat",["dumbbell","bench"],"compound"),
  ex("walking_lunge","Walking Lunge","quads",["glutes"],"squat",["dumbbell"],"compound"),
  ex("reverse_lunge","Reverse Lunge","quads",["glutes"],"squat",["dumbbell"],"compound"),
  ex("step_ups","Step-Ups","quads",["glutes"],"squat",["dumbbell","box"],"compound"),
  ex("leg_extension","Leg Extension","quads",[],"squat",["machine"],"accessory"),
  ex("reverse_nordic","Reverse Nordic","quads",[],"squat",["bodyweight"],"accessory"),
  ex("spanish_squat","Spanish Squat (Band)","quads",[],"squat",["band"],"accessory"),

  // HAMSTRINGS / GLUTES
  ex("rdl_bar","Romanian Deadlift (Barbell)","hamstrings",["glutes","back"],"hinge",["barbell"],"compound"),
  ex("rdl_db","Romanian Deadlift (DB)","hamstrings",["glutes"],"hinge",["dumbbell"],"compound"),
  ex("deadlift_conv","Deadlift (Conventional)","glutes",["hamstrings","back"],"hinge",["barbell"],"compound"),
  ex("deadlift_trap","Deadlift (Trap Bar)","glutes",["quads","hamstrings"],"hinge",["trapbar"],"compound"),
  ex("hip_thrust_bb","Hip Thrust (Barbell)","glutes",["hamstrings"],"hinge",["barbell","bench"],"compound"),
  ex("hip_thrust_machine","Hip Thrust (Machine)","glutes",["hamstrings"],"hinge",["machine"],"compound"),
  ex("glute_bridge","Glute Bridge","glutes",["hamstrings"],"hinge",["barbell","bodyweight"],"accessory"),
  ex("cable_pullthrough","Cable Pull-Through","glutes",["hamstrings"],"hinge",["cable"],"accessory"),
  ex("ham_curl_lying","Leg Curl (Lying)","hamstrings",[],"hinge",["machine"],"accessory"),
  ex("ham_curl_seated","Leg Curl (Seated)","hamstrings",[],"hinge",["machine"],"accessory"),
  ex("nordic_curl","Nordic Curl","hamstrings",[],"hinge",["bodyweight"],"accessory"),
  ex("back_ext_glute","Back Extension (Glute Bias)","glutes",["hamstrings"],"hinge",["bench"],"accessory"),
  ex("sl_rdl","Single-Leg RDL","hamstrings",["glutes"],"hinge",["dumbbell"],"accessory"),
  ex("cable_kickback","Glute Kickback (Cable)","glutes",[],"hinge",["cable"],"accessory"),
  ex("reverse_hyper","Reverse Hyper","glutes",["hamstrings"],"hinge",["machine"],"accessory"),
  ex("good_morning","Good Morning (Light)","hamstrings",["glutes","back"],"hinge",["barbell"],"accessory"),

  // CALVES
  ex("calf_raise_stand","Calf Raise (Standing)","calves",[],"squat",["machine","bodyweight"],"accessory"),
  ex("calf_raise_seated","Calf Raise (Seated)","calves",[],"squat",["machine"],"accessory"),
  ex("calf_press","Calf Press (Leg Press)","calves",[],"squat",["machine"],"accessory"),

  // CHEST
  ex("bench_bb","Bench Press (Barbell)","chest",["triceps","shoulders"],"push",["barbell","bench"],"compound"),
  ex("bench_db","Bench Press (DB)","chest",["triceps","shoulders"],"push",["dumbbell","bench"],"compound"),
  ex("incline_db","Incline DB Bench","chest",["shoulders","triceps"],"push",["dumbbell","bench"],"compound"),
  ex("incline_bb","Incline Bench (Barbell)","chest",["shoulders","triceps"],"push",["barbell","bench"],"compound"),
  ex("decline_bench","Decline Bench","chest",["triceps"],"push",["barbell","bench"],"compound"),
  ex("machine_press","Chest Press (Machine)","chest",["triceps"],"push",["machine"],"compound"),
  ex("plate_press","Plate Loaded Chest Press","chest",["triceps"],"push",["machine"],"compound"),
  ex("cable_fly_hl","Cable Fly (High‚ÜíLow)","chest",[],"push",["cable"],"accessory"),
  ex("cable_fly_lh","Cable Fly (Low‚ÜíHigh)","chest",[],"push",["cable"],"accessory"),
  ex("pec_deck","Pec Deck","chest",[],"push",["machine"],"accessory"),
  ex("pushups","Push-ups","chest",["triceps","shoulders"],"push",["bodyweight"],"compound"),
  ex("dips_chest","Dips (Chest Bias)","chest",["triceps"],"push",["bodyweight"],"compound"),

  // BACK
  ex("lat_pd_wide","Lat Pulldown (Wide)","back",["biceps"],"pull",["cable","machine"],"compound"),
  ex("lat_pd_neutral","Lat Pulldown (Neutral)","back",["biceps"],"pull",["cable","machine"],"compound"),
  ex("pullups","Pull-ups","back",["biceps"],"pull",["bodyweight"],"compound"),
  ex("assisted_pullup","Assisted Pull-up","back",["biceps"],"pull",["machine"],"compound"),
  ex("bb_row","Barbell Row","back",["biceps"],"pull",["barbell"],"compound"),
  ex("chest_supported_row","Chest-Supported Row","back",["biceps"],"pull",["dumbbell","bench","machine"],"compound"),
  ex("seated_cable_row","Seated Cable Row","back",["biceps"],"pull",["cable"],"compound"),
  ex("one_arm_cable_row","One-Arm Cable Row","back",["biceps"],"pull",["cable"],"compound"),
  ex("tbar_row","T-Bar Row","back",["biceps"],"pull",["machine","barbell"],"compound"),
  ex("machine_row","Row (Machine)","back",["biceps"],"pull",["machine"],"compound"),
  ex("straight_arm_pd","Straight-Arm Pulldown","back",[],"pull",["cable"],"accessory"),
  ex("face_pull","Face Pull","shoulders",["back"],"pull",["cable"],"accessory"),
  ex("reverse_pec_deck","Reverse Pec Deck","shoulders",["back"],"pull",["machine"],"accessory"),
  ex("shrug_bb","Shrugs (Barbell)","back",[],"pull",["barbell"],"accessory"),
  ex("shrug_db","Shrugs (DB)","back",[],"pull",["dumbbell"],"accessory"),
  ex("landmine_row","Landmine Row","back",["biceps"],"pull",["barbell","landmine"],"compound"),
  ex("inverted_row","Inverted Row","back",["biceps"],"pull",["bodyweight"],"compound"),
  ex("meadows_row","Meadows Row","back",["biceps"],"pull",["barbell","landmine"],"compound"),

  // SHOULDERS
  ex("ohp_bb","Overhead Press (Barbell)","shoulders",["triceps"],"push",["barbell"],"compound"),
  ex("ohp_db","Shoulder Press (DB)","shoulders",["triceps"],"push",["dumbbell"],"compound"),
  ex("machine_sh_press","Shoulder Press (Machine)","shoulders",["triceps"],"push",["machine"],"compound"),
  ex("arnold_press","Arnold Press","shoulders",["triceps"],"push",["dumbbell"],"compound"),
  ex("lat_raise_db","Lateral Raise (DB)","shoulders",[],"push",["dumbbell"],"accessory"),
  ex("lat_raise_cable","Lateral Raise (Cable)","shoulders",[],"push",["cable"],"accessory"),
  ex("lat_raise_machine","Lateral Raise (Machine)","shoulders",[],"push",["machine"],"accessory"),
  ex("rear_delt_fly","Rear Delt Fly","shoulders",["back"],"pull",["dumbbell","cable","machine"],"accessory"),
  ex("front_raise","Front Raise","shoulders",[],"push",["dumbbell","cable"],"accessory"),
  ex("upright_row","Upright Row","shoulders",["back"],"pull",["barbell","cable"],"accessory"),
  ex("y_raise","Y Raise (Incline Bench)","shoulders",[],"pull",["dumbbell","bench"],"accessory"),
  ex("db_high_incline_press","High Incline Press (DB)","shoulders",["chest"],"push",["dumbbell","bench"],"compound"),

  // BICEPS
  ex("curl_bb","Barbell Curl","biceps",[],"pull",["barbell"],"accessory"),
  ex("curl_ez","EZ-Bar Curl","biceps",[],"pull",["barbell"],"accessory"),
  ex("curl_db","DB Curl","biceps",[],"pull",["dumbbell"],"accessory"),
  ex("hammer_curl","Hammer Curl","biceps",[],"pull",["dumbbell"],"accessory"),
  ex("incline_db_curl","Incline DB Curl (Seated)","biceps",[],"pull",["dumbbell","bench"],"accessory"),
  ex("cable_curl","Cable Curl","biceps",[],"pull",["cable"],"accessory"),
  ex("preacher_curl","Preacher Curl","biceps",[],"pull",["machine","bench"],"accessory"),
  ex("machine_curl","Biceps Curl (Machine)","biceps",[],"pull",["machine"],"accessory"),
  ex("seated_incline_curl_alt","Seated Incline Curl (Alt)","biceps",[],"pull",["dumbbell","bench"],"accessory"),

  // TRICEPS
  ex("rope_pushdown","Rope Pushdown","triceps",[],"push",["cable"],"accessory"),
  ex("bar_pushdown","Straight Bar Pushdown","triceps",[],"push",["cable"],"accessory"),
  ex("skullcrusher","Skull Crushers","triceps",[],"push",["barbell","dumbbell","bench"],"accessory"),
  ex("oh_cable_ext","Overhead Cable Extension","triceps",[],"push",["cable"],"accessory"),
  ex("oh_db_ext","Overhead DB Extension","triceps",[],"push",["dumbbell"],"accessory"),
  ex("close_grip_bench","Close-Grip Bench","triceps",["chest"],"push",["barbell","bench"],"compound"),
  ex("dips_triceps","Dips (Triceps Bias)","triceps",["chest"],"push",["bodyweight"],"compound"),
  ex("machine_triceps","Triceps Extension (Machine)","triceps",[],"push",["machine"],"accessory"),

  // CORE
  ex("plank","Plank","core",[],"core",["bodyweight"],"core"),
  ex("side_plank","Side Plank","core",[],"core",["bodyweight"],"core"),
  ex("cable_crunch","Cable Crunch","core",[],"core",["cable"],"core"),
  ex("hanging_knee_raise","Hanging Knee Raise","core",[],"core",["bodyweight"],"core"),
  ex("hanging_leg_raise","Hanging Leg Raise","core",[],"core",["bodyweight"],"core"),
  ex("dead_bug","Dead Bug","core",[],"core",["bodyweight"],"core"),
  ex("pallof","Pallof Press","core",[],"core",["cable","band"],"core"),
  ex("ab_wheel","Ab Wheel","core",[],"core",["bodyweight"],"core"),
  ex("weighted_situp","Weighted Sit-up","core",[],"core",["plate"],"core"),
  ex("back_ext_neutral","Back Extension (Neutral)","core",["glutes"],"hinge",["bench"],"core"),

  // CARDIO / MOBILITY
  ex("zone2","Zone 2 Cardio","cardio",[],"cardio",["treadmill","bike","rower"],"cardio"),
  ex("intervals","Intervals","cardio",[],"cardio",["treadmill","bike","rower"],"cardio"),
  ex("incline_walk","Incline Walk","cardio",[],"cardio",["treadmill"],"cardio"),
  ex("mobility_flow","Mobility Flow","mobility",[],"mobility",["bodyweight"],"mobility"),
  ex("hips_ankles","Hips + Ankles Mobility","mobility",[],"mobility",["bodyweight"],"mobility"),
  ex("shoulder_mob","Shoulder Mobility","mobility",[],"mobility",["band"],"mobility"),
];

function ex(id,name,primary,secondary,pattern,equipment,category){
  return { id, name, primaryMuscle:primary, secondaryMuscles:secondary, movementPattern:pattern, equipment, category };
}
const EX_BY_ID = Object.fromEntries(EX.map(e=>[e.id,e]));

/* ------------------------- State ------------------------- */
let state = {
  v: 10,
  units: "imperial",
  onboarded: false,
  selectedISO: null,
  profile: {
    goalType: "hybrid",
    exp: "beginner",
    height: null,
    weight: null,
    daysPerWeek: 4,
    timePerSession: 40,
    mobility: "mid",
    cardioPref: "some",
    alcohol: 1,
    lifestyle: "light",
    limitations: ""
  },
  plan: { week: [], weekStartISO: null },
  logs: {
    waterByISO: {},
    workoutByISO: {}, // { completed, checks, setLogs: { exKey: { sets:[{reps,weight}], lastRec } } }
    weightEntries: []
  }
};

/* ------------------------- Helpers ------------------------- */
const isoToday = () => new Date().toISOString().slice(0,10);
function addDaysISO(iso, days){
  const d = new Date(iso + "T00:00:00");
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0,10);
}
function dowFromISO(iso){ return new Date(iso + "T00:00:00").getDay(); }
function round1(x){ return Math.round(x*10)/10; }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function numOrNull(v){ const n = parseFloat(v); return Number.isFinite(n) ? n : null; }
function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
function lbsToKg(lbs){ return lbs / 2.2046226218; }
function kgToLbs(kg){ return kg * 2.2046226218; }

/* ------------------------- Storage ------------------------- */
function save(){ try { localStorage.setItem("myfitState", JSON.stringify(state)); } catch(e){} }
function load(){
  try{
    const raw = localStorage.getItem("myfitState");
    if(raw){
      const parsed = JSON.parse(raw);
      state = Object.assign({}, state, parsed);
    }
  }catch(e){}
}

/* ------------------------- UI Top helpers ------------------------- */
function openProfileHint(){ alert("Profile: We'll expand this later (cloud + profile settings)."); }
function openQuickHelp(){ alert("Tip: Tap an exercise ‚Üí Log sets. Use Audible for swaps/rest/replace. Export/Import in Settings."); }
function connectedAppsHint(){ alert("Connected Apps: Phase 2 (Health/Strava). For now, manual logging."); }

/* ------------------------- Tabs ------------------------- */
function setTopTitle(name){
  document.getElementById("topTitle").innerText = name;
}
function showTab(name){
  ["today","plan","goal","settings"].forEach(t=>{
    document.getElementById(`view-${t}`).classList.add("hidden");
    document.getElementById(`nav-${t}`).classList.remove("active");
  });
  document.getElementById(`view-${name}`).classList.remove("hidden");
  document.getElementById(`nav-${name}`).classList.add("active");

  setTopTitle(
    name==="today" ? "Today" :
    name==="plan" ? "Your Plan" :
    name==="goal" ? "Progress" :
    "Settings"
  );

  renderAll();
}

/* ------------------------- Units ------------------------- */
function setUnits(u){
  if(state.units === u) return;
  state.units = u;

  const p = state.profile;
  if (p.weight != null) p.weight = (u==="metric") ? round1(lbsToKg(p.weight)) : round1(kgToLbs(p.weight));
  if (p.height != null) p.height = (u==="metric") ? round1(p.height * 2.54) : round1(p.height / 2.54);

  save();
  renderAll();
}

/* ------------------------- Onboarding ------------------------- */
function nextStep(n){
  document.getElementById("step1").classList.toggle("hidden", n!==1);
  document.getElementById("step2").classList.toggle("hidden", n!==2);
}
function finishOnboarding(){
  const p = state.profile;
  p.goalType = document.getElementById("goalType").value;
  p.exp = document.getElementById("exp").value;
  p.height = numOrNull(document.getElementById("height").value);
  p.weight = numOrNull(document.getElementById("weight").value);
  p.daysPerWeek = parseInt(document.getElementById("daysPerWeek").value, 10);
  p.timePerSession = parseInt(document.getElementById("timePerSession").value, 10);
  p.mobility = document.getElementById("mobility").value;
  p.cardioPref = document.getElementById("cardioPref").value;
  p.alcohol = parseInt(document.getElementById("alcohol").value, 10);
  p.lifestyle = document.getElementById("lifestyle").value;
  p.limitations = document.getElementById("limitations").value || "";

  if (p.weight == null){ alert("Enter weight to generate water target + plan."); return; }

  state.onboarded = true;
  state.selectedISO = isoToday();
  buildWeekForISO(state.selectedISO, true);
  ensureLogsForISO(state.selectedISO);

  save();
  document.getElementById("onboarding").classList.add("hidden");
  showTab("today");
}

/* ------------------------- Plan generation ------------------------- */
function weekStartSundayISO(anyISO){
  const d = new Date(anyISO + "T00:00:00");
  d.setDate(d.getDate() - d.getDay());
  return d.toISOString().slice(0,10);
}
function pickTrainDays(n){
  const patterns = { 3:[1,3,5], 4:[1,2,4,6], 5:[1,2,3,5,6], 6:[1,2,3,4,5,6] };
  return patterns[n] || patterns[4];
}
function restTitleFor(p){ return p.mobility === "high" ? "Mobility + Easy Walk" : "Rest / Light Walk"; }

/* Template builder uses exercise library so swaps stay consistent */
function templateUpper(){
  return [
    mk("bench_bb"), mk("lat_pd_neutral"),
    mk("ohp_db"), mk("seated_cable_row"),
    mk("lat_raise_db"), mk("rope_pushdown"), mk("incline_db_curl"), mk("plank")
  ];
}
function templateLower(){
  return [
    mk("leg_press_plate"), mk("rdl_bar"),
    mk("bulgarian_split"), mk("ham_curl_seated"),
    mk("leg_extension"), mk("calf_raise_seated"), mk("dead_bug")
  ];
}
function templateFull(){
  return [
    mk("goblet_squat"), mk("bench_db"),
    mk("chest_supported_row"), mk("hip_thrust_bb"),
    mk("lat_raise_cable"), mk("hammer_curl"), mk("pallof")
  ];
}
function templateCardio(){
  return [ mk("zone2"), mk("mobility_flow") ];
}
function templateMobility(){
  return [ mk("hips_ankles"), mk("shoulder_mob"), mk("mobility_flow") ];
}

function mk(exId){
  const e = EX_BY_ID[exId];
  const { sets, repRange } = defaultPrescription(e);
  return {
    key: exId + "-" + Math.random().toString(16).slice(2,8),
    exId,
    sets,
    repRange, // {min,max} or null
  };
}

function defaultPrescription(e){
  // Baseline by category & experience
  const exp = state.profile.exp;
  const goal = state.profile.goalType;

  // Rep ranges
  let repRange = null;
  let sets = 3;

  if(e.category === "compound"){
    sets = exp==="beginner" ? 3 : exp==="intermediate" ? 4 : 5;
    // hybrid/fat lean slightly higher reps; muscle moderate; endurance higher
    if(goal==="endurance") repRange = {min:8,max:12};
    else if(goal==="fat") repRange = {min:8,max:12};
    else if(goal==="hybrid") repRange = {min:6,max:10};
    else repRange = {min:6,max:10}; // muscle
  } else if(e.category === "accessory"){
    sets = exp==="beginner" ? 3 : 3;
    repRange = goal==="endurance" ? {min:12,max:20} : {min:10,max:15};
  } else if(e.category === "core"){
    sets = 3;
    repRange = null; // time/reps
  } else if(e.category === "cardio"){
    sets = 1;
    repRange = null;
  } else if(e.category === "mobility"){
    sets = 1;
    repRange = null;
  }

  return { sets, repRange };
}

function buildWeekForISO(anyISO, force){
  const startISO = weekStartSundayISO(anyISO);
  if(!force && state.plan.weekStartISO === startISO && state.plan.week?.length) return;

  const p = state.profile;
  const trainDays = pickTrainDays(p.daysPerWeek);
  state.plan.weekStartISO = startISO;
  state.plan.week = [];

  // rotate templates based on goal a bit
  const blocks =
    p.goalType==="endurance" ? ["cardio","full","cardio","full"] :
    p.goalType==="muscle" ? ["upper","lower","upper","lower"] :
    p.goalType==="fat" ? ["full","cardio","upper","lower"] :
    ["upper","cardio","lower","full"]; // hybrid

  let bi = 0;
  for(let i=0;i<7;i++){
    const iso = addDaysISO(startISO, i);
    if(trainDays.includes(i)){
      const b = blocks[bi % blocks.length];
      bi++;
      const items =
        b==="upper" ? templateUpper() :
        b==="lower" ? templateLower() :
        b==="full" ? templateFull() :
        b==="cardio" ? templateCardio() :
        templateMobility();

      state.plan.week.push({
        iso, type:"workout",
        title: b==="cardio" ? "Cardio + Mobility" :
               b==="upper" ? "Upper Body" :
               b==="lower" ? "Lower Body" :
               b==="full" ? "Full Body" : "Mobility",
        items
      });
    } else {
      state.plan.week.push({ iso, type:"rest", title: restTitleFor(p), items: [] });
    }
  }
}

function getPlanForISO(iso){
  buildWeekForISO(iso, false);
  return state.plan.week.find(d => d.iso === iso);
}

/* ------------------------- Logs ------------------------- */
function computeWaterTarget(){
  const wt = state.profile.weight;
  if (wt == null) return { unit:"oz", glassSize:16, targetGlasses:4 };
  if (state.units === "imperial"){
    const targetOz = Math.round(wt * 0.5);
    const glassSize = 16;
    const targetGlasses = clamp(Math.round(targetOz / glassSize), 3, 10);
    return { unit:"oz", glassSize, targetGlasses };
  } else {
    const targetMl = Math.round(wt * 30);
    const glassSize = 500;
    const targetGlasses = clamp(Math.round(targetMl / glassSize), 3, 10);
    return { unit:"ml", glassSize, targetGlasses };
  }
}

function ensureLogsForISO(iso){
  if(!state.logs.waterByISO[iso]){
    const tgt = computeWaterTarget();
    state.logs.waterByISO[iso] = {
      unit: tgt.unit,
      glassSize: tgt.glassSize,
      targetGlasses: tgt.targetGlasses,
      glassesDone: Array(tgt.targetGlasses).fill(false)
    };
  }
  if(!state.logs.workoutByISO[iso]){
    state.logs.workoutByISO[iso] = {
      completed:false,
      checks:{},
      setLogs:{} // keyed by item.key
    };
  } else {
    state.logs.workoutByISO[iso].checks = state.logs.workoutByISO[iso].checks || {};
    state.logs.workoutByISO[iso].setLogs = state.logs.workoutByISO[iso].setLogs || {};
  }
}

/* ------------------------- Navigation ------------------------- */
function shiftSelected(delta){
  state.selectedISO = addDaysISO(state.selectedISO, delta);
  buildWeekForISO(state.selectedISO, false);
  ensureLogsForISO(state.selectedISO);
  save();
  renderAll();
}
function jumpToToday(){
  state.selectedISO = isoToday();
  buildWeekForISO(state.selectedISO, false);
  ensureLogsForISO(state.selectedISO);
  save();
  renderAll();
}

/* ------------------------- Hero & Week strip ------------------------- */
function computeWeeklyAdherence(){
  const planned = state.plan.week.filter(d=>d.type==="workout").length;
  if(!planned) return 0;
  let completed = 0;
  for(const d of state.plan.week){
    const log = state.logs.workoutByISO[d.iso];
    if(d.type==="workout" && log?.completed) completed++;
  }
  return Math.round((completed/planned)*100);
}

function renderHero(){
  const goalName = ({
    fat:"Lose Fat Plan",
    muscle:"Build Muscle Plan",
    hybrid:"Functional Plan",
    endurance:"Endurance Plan"
  })[state.profile.goalType] || "Your Plan";

  document.getElementById("heroName").innerText = goalName;
  document.getElementById("heroMeta").innerText = `Week of ${state.plan.weekStartISO}`;

  const planned = state.plan.week.filter(d=>d.type==="workout").length;
  const done = state.plan.week.filter(d=>d.type==="workout" && state.logs.workoutByISO[d.iso]?.completed).length;
  const adh = computeWeeklyAdherence();

  document.getElementById("heroDone").innerText = `${done}/${planned}`;
  document.getElementById("heroAdh").innerText = `${adh}%`;

  const bar = planned ? Math.round((done/planned)*100) : 0;
  document.getElementById("heroBar").style.width = `${bar}%`;
}

function renderWeekStrip(){
  const strip = document.getElementById("weekStrip");
  strip.innerHTML = "";
  for(const d of state.plan.week){
    const dt = new Date(d.iso + "T00:00:00");
    const pill = document.createElement("button");
    pill.className = "pill" + (d.iso===state.selectedISO ? " sel":"");
    pill.onclick = ()=>{
      state.selectedISO = d.iso;
      ensureLogsForISO(d.iso);
      save();
      renderAll();
    };
    pill.innerHTML = `<div class="dow">${DOW[dt.getDay()]}</div><div class="day">${dt.getDate()}</div>`;
    strip.appendChild(pill);
  }
}

/* ------------------------- Water ------------------------- */
function renderWater(){
  const iso = state.selectedISO;
  ensureLogsForISO(iso);
  const w = state.logs.waterByISO[iso];
  const done = w.glassesDone.filter(Boolean).length;

  document.getElementById("waterSummary").innerText = `${done}/${w.targetGlasses}`;
  document.getElementById("waterTargetText").innerText =
    (state.units==="imperial")
      ? `Target: ${w.targetGlasses} √ó ${w.glassSize}oz`
      : `Target: ${w.targetGlasses} √ó ${w.glassSize}ml`;

  const container = document.getElementById("glasses");
  container.innerHTML = "";

  w.glassesDone.forEach((isDone, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "glasswrap";

    const g = document.createElement("button");
    g.className = "glass" + (isDone ? " done":"");
    g.style.cursor = "pointer";
    g.onclick = ()=>toggleGlassSelected(idx);

    const fill = document.createElement("div"); fill.className = "fill";
    const check = document.createElement("div"); check.className = "check"; check.textContent = "‚úì";
    g.appendChild(fill); g.appendChild(check);

    const label = document.createElement("div");
    label.className = "glasslabel";
    label.textContent = (state.units==="imperial") ? "16oz" : `${w.glassSize}ml`;

    wrap.appendChild(g);
    wrap.appendChild(label);
    container.appendChild(wrap);
  });
}
function toggleGlassSelected(i){
  const iso = state.selectedISO;
  const w = state.logs.waterByISO[iso];
  w.glassesDone[i] = !w.glassesDone[i];
  save();
  renderAll();
}
function resetWaterSelected(){
  const iso = state.selectedISO;
  const w = state.logs.waterByISO[iso];
  w.glassesDone = w.glassesDone.map(()=>false);
  save();
  renderAll();
}

/* ------------------------- Workout rendering + set logging ------------------------- */
let setModalCtx = null; // { iso, itemKey }

function renderWorkout(){
  const iso = state.selectedISO;
  ensureLogsForISO(iso);
  const day = getPlanForISO(iso);
  const log = state.logs.workoutByISO[iso];

  const summaryEl = document.getElementById("workoutSummary");
  const titleEl = document.getElementById("dayTitle");
  const listEl = document.getElementById("workoutList");

  if(!day){
    summaryEl.innerText = "‚Äî";
    titleEl.innerText = "‚Äî";
    listEl.innerHTML = `<div class="sub">No plan found.</div>`;
    return;
  }

  titleEl.innerText = day.title;

  if(day.type === "rest"){
    summaryEl.innerText = "Rest";
    listEl.innerHTML = `<div class="sub">üòå Rest day. Use Audible to replace with a workout if you want.</div>`;
    return;
  }

  // completion summary
  const total = day.items.length;
  const doneCount = day.items.filter(it => !!log.checks[it.key]).length;
  summaryEl.innerText = `${doneCount}/${total}`;

  listEl.innerHTML = "";

  day.items.forEach(item=>{
    const e = EX_BY_ID[item.exId];
    const row = document.createElement("div");
    row.className = "witem";

    const check = document.createElement("button");
    const isDone = !!log.checks[item.key];
    check.className = "wcheck" + (isDone ? " done":"");
    check.textContent = isDone ? "‚úì" : "";
    check.onclick = ()=>toggleItemDone(item.key);

    const info = document.createElement("div");
    info.style.flex = "1";

    const name = document.createElement("div");
    name.className = "wname";
    name.textContent = e.name;

    const meta = document.createElement("div");
    meta.className = "wmeta";

    const muscleChip = `<span class="chip">${MUSCLE_LABEL[e.primaryMuscle] || e.primaryMuscle}</span>`;
    const patternChip = `<span class="chip">${PATTERN_LABEL[e.movementPattern] || e.movementPattern}</span>`;
    const presc = prescriptionText(item, e);
    const prescChip = `<span class="chip">${presc}</span>`;
    meta.innerHTML = muscleChip + patternChip + prescChip;

    // Next time hint if we have a recommendation
    const setLog = log.setLogs[item.key];
    const nextHint = document.createElement("div");
    nextHint.className = "nextHint";
    nextHint.textContent = setLog?.nextSuggestion ? `Next time: ${setLog.nextSuggestion}` : "";

    info.appendChild(name);
    info.appendChild(meta);
    if(nextHint.textContent) info.appendChild(nextHint);

    const right = document.createElement("div");
    right.className = "rightBtns";

    const logBtn = document.createElement("button");
    logBtn.className = "miniBtn primary";
    logBtn.textContent = "Log Sets";
    logBtn.onclick = ()=>openSetModal(item.key);

    const swapBtn = document.createElement("button");
    swapBtn.className = "miniBtn";
    swapBtn.textContent = "Swap";
    swapBtn.onclick = ()=>{
      openAudible();
      setAudMode(0);
      // preselect this item
      setTimeout(()=>{
        const sel = document.getElementById("swapFrom");
        if(sel){
          sel.value = item.key;
          renderSwapCandidates();
        }
      }, 0);
    };

    right.appendChild(logBtn);
    right.appendChild(swapBtn);

    row.appendChild(check);
    row.appendChild(info);
    row.appendChild(right);

    listEl.appendChild(row);
  });
}

function prescriptionText(item, e){
  if(e.category==="cardio") return "20‚Äì40 min";
  if(e.category==="mobility") return "10‚Äì20 min";
  if(e.category==="core") return `${item.sets} sets`;
  if(!item.repRange) return `${item.sets} sets`;
  return `${item.sets}√ó${item.repRange.min}‚Äì${item.repRange.max}`;
}

function toggleItemDone(itemKey){
  const iso = state.selectedISO;
  const log = state.logs.workoutByISO[iso];
  log.checks[itemKey] = !log.checks[itemKey];
  save();
  renderAll();
}

function completeSelectedWorkout(){
  const iso = state.selectedISO;
  ensureLogsForISO(iso);
  const day = getPlanForISO(iso);
  if(day?.type !== "workout"){
    alert("This day is Rest. Use Audible to replace with a workout.");
    return;
  }
  state.logs.workoutByISO[iso].completed = true;
  save();
  renderAll();
}

/* ------------------------- Set Logger Modal ------------------------- */
function openSetModal(itemKey){
  const iso = state.selectedISO;
  const day = getPlanForISO(iso);
  const item = day.items.find(i=>i.key===itemKey);
  const e = EX_BY_ID[item.exId];

  setModalCtx = { iso, itemKey };

  document.getElementById("setTitle").innerText = `Log Sets ‚Ä¢ ${e.name}`;
  document.getElementById("setMeta").innerText =
    `${MUSCLE_LABEL[e.primaryMuscle]} ‚Ä¢ ${PATTERN_LABEL[e.movementPattern]} ‚Ä¢ ${prescriptionText(item,e)}`;

  // build rows
  const log = state.logs.workoutByISO[iso];
  const existing = log.setLogs[itemKey]?.sets || [];
  const desiredSets = item.sets || 3;
  const sets = existing.length ? existing : Array.from({length:desiredSets}, ()=>({reps:"",weight:""}));

  renderSetRows(sets);

  // show current rec based on existing sets
  document.getElementById("setRec").innerText = "‚Äî";

  document.getElementById("setModal").classList.add("show");
}

function renderSetRows(sets){
  const container = document.getElementById("setRows");
  container.innerHTML = "";

  sets.forEach((s, idx)=>{
    const box = document.createElement("div");
    box.className = "listItem";

    const top = document.createElement("div");
    top.className = "listItemTop";
    top.innerHTML = `<div class="listItemName">Set ${idx+1}</div><div class="tiny">${state.units==="imperial" ? "lb" : "kg"}</div>`;

    const row = document.createElement("div");
    row.className = "row";
    row.style.marginTop = "10px";

    const reps = document.createElement("input");
    reps.type = "number";
    reps.placeholder = "Reps";
    reps.value = s.reps ?? "";
    reps.oninput = ()=>{ s.reps = reps.value; previewRecommendation(); };

    const wt = document.createElement("input");
    wt.type = "number";
    wt.placeholder = "Weight";
    wt.value = s.weight ?? "";
    wt.oninput = ()=>{ s.weight = wt.value; previewRecommendation(); };

    row.appendChild(reps);
    row.appendChild(wt);

    box.appendChild(top);
    box.appendChild(row);
    container.appendChild(box);
  });

  // stash sets in DOM for add/remove
  container._sets = sets;
  previewRecommendation();
}

function addSetRow(){
  const container = document.getElementById("setRows");
  const sets = container._sets || [];
  sets.push({reps:"",weight:""});
  renderSetRows(sets);
}
function removeSetRow(){
  const container = document.getElementById("setRows");
  const sets = container._sets || [];
  if(sets.length<=1) return;
  sets.pop();
  renderSetRows(sets);
}

function previewRecommendation(){
  if(!setModalCtx) return;
  const { iso, itemKey } = setModalCtx;
  const day = getPlanForISO(iso);
  const item = day.items.find(i=>i.key===itemKey);
  const e = EX_BY_ID[item.exId];

  const sets = (document.getElementById("setRows")._sets || []).map(s=>({
    reps: parseInt(s.reps,10),
    weight: parseFloat(s.weight)
  })).filter(x=>Number.isFinite(x.reps) && Number.isFinite(x.weight));

  const rec = computeNextSuggestion(e, item, sets);
  document.getElementById("setRec").innerText = rec ? `Recommendation: ${rec}` : "Recommendation: ‚Äî";
}

function saveSetLog(){
  if(!setModalCtx) return;
  const { iso, itemKey } = setModalCtx;
  const day = getPlanForISO(iso);
  const item = day.items.find(i=>i.key===itemKey);
  const e = EX_BY_ID[item.exId];

  const setsRaw = (document.getElementById("setRows")._sets || []);
  const sets = setsRaw.map(s=>({
    reps: numOrNull(s.reps),
    weight: numOrNull(s.weight)
  }));

  // Save
  const log = state.logs.workoutByISO[iso];
  log.setLogs[itemKey] = log.setLogs[itemKey] || {};
  log.setLogs[itemKey].sets = sets;

  // Compute and store next suggestion
  const compact = sets.filter(x=>x.reps!=null && x.weight!=null);
  const suggestion = computeNextSuggestion(e, item, compact);
  log.setLogs[itemKey].nextSuggestion = suggestion || "";

  // mark item checked if all sets have data
  const allFilled = sets.length && sets.every(s=>s.reps!=null && s.weight!=null);
  if(allFilled) log.checks[itemKey] = true;

  save();
  closeSetModal();
  renderAll();
}

function closeSetModal(){
  document.getElementById("setModal").classList.remove("show");
  setModalCtx = null;
}

function computeNextSuggestion(e, item, loggedSets){
  // If not enough data, no suggestion
  if(!loggedSets || loggedSets.length===0) return "";

  // For cardio/mobility/core: skip
  if(e.category==="cardio") return "Add 2‚Äì5 min next time";
  if(e.category==="mobility") return "Add 2‚Äì5 min next time";
  if(e.category==="core") return "Add reps/time next time";

  // Determine target rep range
  const rr = item.repRange || (e.category==="accessory" ? {min:10,max:15} : {min:6,max:10});
  const reps = loggedSets.map(s=>s.reps);
  const weights = loggedSets.map(s=>s.weight);

  // Use the "working weight" as median-ish (average)
  const w = weights.reduce((a,b)=>a+b,0) / weights.length;
  const allAtOrAboveMax = reps.every(r=>r >= rr.max);
  const allAtOrAboveMin = reps.every(r=>r >= rr.min);

  // Determine micro progression constraints
  // Dumbbells: if big jump, we microprogress (reps/tempo/sets). We don't know DB increments; assume could be 5 lb jumps.
  // Barbell upper: +2.5, lower: +5 (your C rule).
  const isUpperCompound = e.category==="compound" && ["chest","shoulders","back"].includes(e.primaryMuscle) && e.movementPattern!=="squat" && e.movementPattern!=="hinge";
  const isLowerCompound = e.category==="compound" && ["quads","glutes","hamstrings","calves"].includes(e.primaryMuscle) && (e.movementPattern==="squat" || e.movementPattern==="hinge");
  const isAccessory = e.category==="accessory";

  // If hit top on all sets: suggest progress
  if(allAtOrAboveMax){
    if(isLowerCompound) return `${roundTo(w + 5)} ${unitLabel()} for ${item.sets}√ó${rr.min}‚Äì${rr.max}`;
    if(isUpperCompound) return `${roundTo(w + 2.5)} ${unitLabel()} for ${item.sets}√ó${rr.min}‚Äì${rr.max}`;

    // Accessory / dumbbell microprogression
    // If next increment likely big, recommend reps/tempo first
    return microAccessorySuggestion(w, rr, item.sets);
  }

  // If mostly hitting top (e.g. average >= max-1): push reps up
  const avgReps = reps.reduce((a,b)=>a+b,0) / reps.length;
  if(avgReps >= rr.max - 1 && allAtOrAboveMin){
    return `${roundTo(w)} ${unitLabel()} ‚Ä¢ aim ${rr.max} reps each set`;
  }

  // If below min: reduce load slightly or reduce reps target
  const belowMin = reps.some(r=>r < rr.min);
  if(belowMin){
    const dec = isLowerCompound ? 5 : isUpperCompound ? 2.5 : 2.5;
    return `${roundTo(Math.max(0, w - dec))} ${unitLabel()} ‚Ä¢ aim ${rr.min} reps`;
  }

  // Otherwise: keep weight, push reps
  return `${roundTo(w)} ${unitLabel()} ‚Ä¢ add 1 rep per set if possible`;
}

function microAccessorySuggestion(w, rr, sets){
  // "B" choice: microprogress before big jump
  // Suggest: add reps toward top; if already top, tempo or +set; then jump later.
  // We don't track history across sessions here yet, so we propose step 1.
  if(rr.max < 15){
    return `${roundTo(w)} ${unitLabel()} ‚Ä¢ next: push reps toward ${rr.max} (clean form)`;
  }
  return `${roundTo(w)} ${unitLabel()} ‚Ä¢ next: slow eccentric (3s down) OR +1 set`;
}

function roundTo(val){
  // keep 0.5 precision for kg/lb display; avoid long floats
  return Math.round(val * 2) / 2;
}
function unitLabel(){ return state.units==="imperial" ? "lb" : "kg"; }

/* ------------------------- Analyze ------------------------- */
function analyzeDay(){
  const iso = state.selectedISO;
  ensureLogsForISO(iso);
  const day = getPlanForISO(iso);
  const w = state.logs.waterByISO[iso];
  const log = state.logs.workoutByISO[iso];

  const waterDone = w.glassesDone.filter(Boolean).length;
  const waterTarget = w.targetGlasses;

  let workoutStatus = "Rest day üòå";
  if(day.type==="workout"){
    workoutStatus = log.completed ? "Workout completed ‚úÖ" : "Workout not marked complete ‚è≥";
  }

  // count suggestions ready
  let ready = 0;
  if(day.type==="workout"){
    for(const it of day.items){
      const rec = log.setLogs[it.key]?.nextSuggestion;
      if(rec && rec.toLowerCase().includes("aim")===false) ready++; // rough
    }
  }

  const adh = computeWeeklyAdherence();
  document.getElementById("analysisOut").innerText =
    `Water ${waterDone}/${waterTarget} ‚Ä¢ ${workoutStatus} ‚Ä¢ ${ready} exercises have next-step guidance ‚Ä¢ Weekly adherence ${adh}%`;
}

/* ------------------------- Plan grid ------------------------- */
function renderWeekGrid(){
  const grid = document.getElementById("weekGrid");
  grid.innerHTML = "";
  const sel = state.selectedISO;

  for(const d of state.plan.week){
    const box = document.createElement("div");
    box.className = "dayBox" + (d.iso===sel ? " sel":"");

    const dow = document.createElement("div");
    dow.className = "dow";
    dow.textContent = DOW[dowFromISO(d.iso)];

    const what = document.createElement("div");
    what.className = "what";
    what.textContent = d.title;

    box.appendChild(dow);
    box.appendChild(what);
    box.onclick = ()=>{
      state.selectedISO = d.iso;
      ensureLogsForISO(d.iso);
      save();
      renderAll();
      showTab("today");
    };

    grid.appendChild(box);
  }

  const planned = state.plan.week.filter(d=>d.type==="workout").length;
  const done = state.plan.week.filter(d=>d.type==="workout" && state.logs.workoutByISO[d.iso]?.completed).length;
  const adh = computeWeeklyAdherence();
  document.getElementById("weeklySummary").innerText = `Workouts completed ${done}/${planned} ‚Ä¢ Adherence ${adh}%`;
}

/* ------------------------- Goal/Settings ------------------------- */
function openGoalChange(){
  document.getElementById("goalChange").classList.remove("hidden");
  document.getElementById("newGoalType").value = state.profile.goalType;
  document.getElementById("newDays").value = String(state.profile.daysPerWeek);
  document.getElementById("newTime").value = String(state.profile.timePerSession);
}
function closeGoalChange(){
  document.getElementById("goalChange").classList.add("hidden");
}
function applyGoalChange(){
  state.profile.goalType = document.getElementById("newGoalType").value;
  state.profile.daysPerWeek = parseInt(document.getElementById("newDays").value,10);
  state.profile.timePerSession = parseInt(document.getElementById("newTime").value,10);
  buildWeekForISO(state.selectedISO, true);
  closeGoalChange();
  save();
  renderAll();
}
function saveWeight(){
  const v = numOrNull(document.getElementById("setWeight").value);
  if(v == null){ alert("Enter a number."); return; }
  state.logs.weightEntries.push({ iso: state.selectedISO || isoToday(), value: v });
  document.getElementById("setWeight").value = "";
  save();
  renderAll();
}
function exportState(){
  const box = document.getElementById("exportBox");
  box.classList.remove("hidden");
  box.value = JSON.stringify(state);
}
function importState(){
  const raw = document.getElementById("importBox").value.trim();
  if(!raw){ alert("Paste JSON."); return; }
  try{
    const parsed = JSON.parse(raw);
    state = Object.assign({}, state, parsed);
    save();
    alert("Imported.");
    renderAll();
  }catch(e){
    alert("Invalid JSON.");
  }
}
function wipeAll(){
  if(!confirm("Wipe all myFit data?")) return;
  try{ localStorage.removeItem("myfitState"); }catch(e){}
  location.reload();
}

/* ------------------------- Audible Modal (Swap/Rest/Replace) ------------------------- */
let audMode = 0;
let audAccessory = false;

function openAudible(){
  document.getElementById("audibleModal").classList.add("show");
  setAudMode(audMode);
  populateSwapFrom();
  renderSwapCandidates();
}
function closeAudible(){
  document.getElementById("audibleModal").classList.remove("show");
}
function closeModalOnBackdrop(ev, id){
  if(ev.target.id === id){
    document.getElementById(id).classList.remove("show");
  }
}
function setAudMode(m){
  audMode = m;
  document.getElementById("audMode0").classList.toggle("active", m===0);
  document.getElementById("audMode1").classList.toggle("active", m===1);
  document.getElementById("audMode2").classList.toggle("active", m===2);

  document.getElementById("audSwap").classList.toggle("hidden", m!==0);
  document.getElementById("audRest").classList.toggle("hidden", m!==1);
  document.getElementById("audReplace").classList.toggle("hidden", m!==2);

  document.getElementById("audibleOut").innerText = "‚Äî";
}

function toggleAccessory(){
  audAccessory = !audAccessory;
  document.getElementById("accToggle").innerText = audAccessory ? "On" : "Off";
  renderSwapCandidates();
}

function populateSwapFrom(){
  const iso = state.selectedISO;
  const day = getPlanForISO(iso);
  const sel = document.getElementById("swapFrom");
  sel.innerHTML = "";

  if(!day || day.type!=="workout"){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No workout items today";
    sel.appendChild(opt);
    return;
  }

  day.items.forEach(it=>{
    const e = EX_BY_ID[it.exId];
    const opt = document.createElement("option");
    opt.value = it.key;
    opt.textContent = e.name;
    sel.appendChild(opt);
  });

  // keep current selection if possible
  if(!sel.value && day.items[0]) sel.value = day.items[0].key;
}

function renderSwapCandidates(){
  const iso = state.selectedISO;
  const day = getPlanForISO(iso);
  const out = document.getElementById("audibleOut");

  if(!day || day.type!=="workout"){
    document.getElementById("swapFromMeta").innerHTML = `<span class="chip">No workout</span>`;
    document.getElementById("swapCandidates").innerHTML = `<div class="sub">This is a rest day. Use ‚ÄúReplace‚Äù to make a workout.</div>`;
    return;
  }

  const fromKey = document.getElementById("swapFrom").value;
  const fromItem = day.items.find(i=>i.key===fromKey);
  if(!fromItem) return;
  const fromEx = EX_BY_ID[fromItem.exId];

  // show meta
  document.getElementById("swapFromMeta").innerHTML =
    `<span class="chip">${MUSCLE_LABEL[fromEx.primaryMuscle]}</span>` +
    `<span class="chip">${PATTERN_LABEL[fromEx.movementPattern]}</span>` +
    `<span class="chip">${fromEx.category}</span>`;

  const candidates = rankCandidates(fromEx, audAccessory);

  const list = document.getElementById("swapCandidates");
  list.innerHTML = "";

  // show top 16 to keep UI tight
  const top = candidates.slice(0, 16);
  top.forEach(c=>{
    const e = c.e;
    const box = document.createElement("div");
    box.className = "listItem";

    const topRow = document.createElement("div");
    topRow.className = "listItemTop";
    topRow.innerHTML = `<div class="listItemName">${e.name}</div><div class="tiny">${c.reason}</div>`;

    const meta = document.createElement("div");
    meta.className = "listItemMeta";
    meta.innerHTML =
      `<span class="chip">${MUSCLE_LABEL[e.primaryMuscle]}</span>` +
      `<span class="chip">${PATTERN_LABEL[e.movementPattern]}</span>` +
      `<span class="chip">${e.category}</span>`;

    const btnRow = document.createElement("div");
    btnRow.className = "row";
    btnRow.style.marginTop = "10px";

    const apply = document.createElement("button");
    apply.className = "btn";
    apply.textContent = "Apply swap ‚úÖ";
    apply.onclick = ()=>{
      applySwap(fromKey, e.id);
      out.innerText = `Swapped: ${fromEx.name} ‚Üí ${e.name}`;
    };

    btnRow.appendChild(apply);

    box.appendChild(topRow);
    box.appendChild(meta);
    box.appendChild(btnRow);

    list.appendChild(box);
  });
}

function rankCandidates(fromEx, allowAccessory){
  // Hybrid B+C: match primary muscle OR movement pattern; prefer both.
  // Default hides accessory alternatives unless toggled.
  // Sort:
  // 1) primary+pattern
  // 2) primary
  // 3) pattern
  // 4) secondary muscle match
  const fromPrimary = fromEx.primaryMuscle;
  const fromPattern = fromEx.movementPattern;

  let pool = EX.filter(e => e.id !== fromEx.id);

  // default: keep category tier sane
  // If from is compound, default to compounds; allow accessories only when toggle ON.
  if(fromEx.category === "compound" && !allowAccessory){
    pool = pool.filter(e => e.category === "compound");
  }
  // If from is accessory, keep accessories by default; compounds are ok too but less common
  if(fromEx.category === "accessory" && !allowAccessory){
    pool = pool.filter(e => e.category !== "core" && e.category !== "mobility" && e.category !== "cardio");
  }

  // must match primary OR pattern OR secondary overlap
  const filtered = pool.filter(e=>{
    const secHit = e.secondaryMuscles?.includes(fromPrimary) || fromEx.secondaryMuscles?.includes(e.primaryMuscle);
    return e.primaryMuscle === fromPrimary || e.movementPattern === fromPattern || secHit;
  });

  const ranked = filtered.map(e=>{
    const primary = e.primaryMuscle === fromPrimary;
    const pattern = e.movementPattern === fromPattern;
    const secHit = e.secondaryMuscles?.includes(fromPrimary) || fromEx.secondaryMuscles?.includes(e.primaryMuscle);
    let score = 0;
    let reason = "";

    if(primary && pattern){ score = 100; reason = "best match"; }
    else if(primary){ score = 80; reason = "same muscle"; }
    else if(pattern){ score = 65; reason = "same pattern"; }
    else if(secHit){ score = 50; reason = "secondary match"; }

    // penalize weird category swaps unless accessory toggle is on
    if(fromEx.category==="compound" && e.category==="accessory" && !allowAccessory) score -= 100;
    if(e.category==="cardio" || e.category==="mobility") score -= 80;

    return { e, score, reason };
  }).filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score || a.e.name.localeCompare(b.e.name));

  return ranked;
}

function applySwap(fromKey, toExId){
  const iso = state.selectedISO;
  const day = getPlanForISO(iso);
  ensureLogsForISO(iso);
  const log = state.logs.workoutByISO[iso];

  const idx = day.items.findIndex(i=>i.key===fromKey);
  if(idx<0) return;

  const oldItem = day.items[idx];
  const oldEx = EX_BY_ID[oldItem.exId];
  const newEx = EX_BY_ID[toExId];

  // Hybrid set/rep logic:
  // compound->compound keep structure
  // compound->accessory adjust
  // accessory->compound adjust
  // accessory->accessory keep
  let newSets = oldItem.sets;
  let newRR = oldItem.repRange;

  if(oldEx.category==="compound" && newEx.category==="compound"){
    // keep
  } else if(oldEx.category==="compound" && newEx.category==="accessory"){
    newSets = 3;
    newRR = state.profile.goalType==="endurance" ? {min:12,max:20} : {min:10,max:15};
  } else if(oldEx.category==="accessory" && newEx.category==="compound"){
    newSets = state.profile.exp==="beginner" ? 3 : state.profile.exp==="intermediate" ? 4 : 5;
    newRR = state.profile.goalType==="hybrid" ? {min:6,max:10} : {min:6,max:10};
  } else if(oldEx.category==="accessory" && newEx.category==="accessory"){
    // keep
  } else {
    // fallback to defaults
    const d = defaultPrescription(newEx);
    newSets = d.sets; newRR = d.repRange;
  }

  // Preserve checkmark state for all other items automatically
  // For swapped item: reset its check + set logs
  const newItem = { key: toExId + "-" + Math.random().toString(16).slice(2,8), exId: toExId, sets:newSets, repRange:newRR };

  // Carry over "done" state only if user wants? default: reset
  delete log.checks[oldItem.key];
  delete log.setLogs[oldItem.key];

  day.items[idx] = newItem;

  save();
  renderAll();
}

function setDayRest(rebalance=false){
  const iso = state.selectedISO;
  const idx = state.plan.week.findIndex(d=>d.iso===iso);
  if(idx>=0){
    state.plan.week[idx] = { iso, type:"rest", title: restTitleFor(state.profile), items: [] };
  }
  if(rebalance) rebalanceWeekAfterChange(idx);
  document.getElementById("audibleOut").innerText = rebalance ? "Set to Rest + rebalanced week ‚úÖ" : "Set to Rest ‚úÖ";
  save();
  renderAll();
}

function replaceDayFocus(focus, rebalance=false){
  const iso = state.selectedISO;
  const idx = state.plan.week.findIndex(d=>d.iso===iso);
  if(idx<0) return;

  let items = [];
  let title = "Workout";
  if(focus==="upper"){ items = templateUpper(); title="Upper Body"; }
  else if(focus==="lower"){ items = templateLower(); title="Lower Body"; }
  else if(focus==="full"){ items = templateFull(); title="Full Body"; }
  else if(focus==="cardio"){ items = templateCardio(); title="Cardio + Mobility"; }
  else if(focus==="mobility"){ items = templateMobility(); title="Mobility"; }
  else {
    // if user passed goalType accidentally
    items = templateFull(); title="Full Body";
  }

  state.plan.week[idx] = { iso, type:"workout", title, items };

  // ensure log exists
  ensureLogsForISO(iso);
  // optionally rebalance to maintain weekly workout count
  if(rebalance) rebalanceWeekAfterChange(idx);

  document.getElementById("audibleOut").innerText = rebalance ? "Replaced workout + rebalanced week ‚úÖ" : "Replaced workout ‚úÖ";
  save();
  renderAll();
}

function rebalanceWeekAfterChange(changedIdx){
  // keep weekly workout count aligned with daysPerWeek by flipping the next rest/workout
  const desired = state.profile.daysPerWeek;
  const current = state.plan.week.filter(d=>d.type==="workout").length;
  if(current === desired) return;

  if(current > desired){
    // too many workouts: find a workout day after changedIdx and convert to rest
    const cutIdx = state.plan.week.findIndex((d,i)=> i!==changedIdx && i>changedIdx && d.type==="workout");
    if(cutIdx>=0){
      state.plan.week[cutIdx] = { iso: state.plan.week[cutIdx].iso, type:"rest", title: restTitleFor(state.profile), items: [] };
    }
    return;
  }

  if(current < desired){
    // too few workouts: find a rest day after changedIdx and convert to a default workout
    const addIdx = state.plan.week.findIndex((d,i)=> i!==changedIdx && i>changedIdx && d.type==="rest");
    if(addIdx>=0){
      state.plan.week[addIdx] = { iso: state.plan.week[addIdx].iso, type:"workout", title:"Full Body", items: templateFull() };
    }
  }
}

/* ------------------------- Plan Overview (quick) ------------------------- */
function openPlanOverview(){
  const planned = state.plan.week.filter(d=>d.type==="workout").length;
  const done = state.plan.week.filter(d=>d.type==="workout" && state.logs.workoutByISO[d.iso]?.completed).length;
  alert(`Plan Overview\n\nWeek of ${state.plan.weekStartISO}\nWorkouts: ${done}/${planned}\nAdherence: ${computeWeeklyAdherence()}%`);
}

/* ------------------------- Goal view text ------------------------- */
function renderGoal(){
  const p = state.profile;
  const adh = computeWeeklyAdherence();
  const planned = state.plan.week.filter(d=>d.type==="workout").length;
  const done = state.plan.week.filter(d=>d.type==="workout" && state.logs.workoutByISO[d.iso]?.completed).length;

  document.getElementById("goalText").innerText =
    `Goal: ${(p.goalType==="hybrid"?"Hybrid/Functional":p.goalType)} ‚Ä¢ Days/week: ${p.daysPerWeek} ‚Ä¢ Workouts: ${done}/${planned} ‚Ä¢ Adherence: ${adh}%`;
}

/* ------------------------- Render ------------------------- */
function renderDateChip(){
  const iso = state.selectedISO;
  const d = new Date(iso + "T00:00:00");
  const dow = DOW[d.getDay()];
  const mm = (d.getMonth()+1).toString().padStart(2,"0");
  const dd = d.getDate().toString().padStart(2,"0");
  document.getElementById("selDateChip").innerText = `${dow} ${mm}/${dd}`;
}

function renderAll(){
  document.getElementById("uImp").classList.toggle("active", state.units==="imperial");
  document.getElementById("uMet").classList.toggle("active", state.units==="metric");

  if(!state.onboarded){
    document.getElementById("onboarding").classList.remove("hidden");
    ["today","plan","goal","settings"].forEach(v=>document.getElementById(`view-${v}`).classList.add("hidden"));
    return;
  } else {
    document.getElementById("onboarding").classList.add("hidden");
  }

  if(!state.selectedISO) state.selectedISO = isoToday();
  buildWeekForISO(state.selectedISO, false);
  ensureLogsForISO(state.selectedISO);

  document.getElementById("setWeight").placeholder = state.units==="imperial" ? "Current weight (lb)" : "Current weight (kg)";
  document.getElementById("weightSavedText").innerText = `Saved weight entries: ${state.logs.weightEntries.length}`;

  renderHero();
  renderWeekStrip();
  renderDateChip();
  renderWater();
  renderWorkout();
  renderWeekGrid();
  renderGoal();
}

/* ------------------------- Boot ------------------------- */
load();
if(state.onboarded){
  if(!state.selectedISO) state.selectedISO = isoToday();
  buildWeekForISO(state.selectedISO, true);
  ensureLogsForISO(state.selectedISO);
  save();
  document.getElementById("onboarding").classList.add("hidden");
  showTab("today");
} else {
  setTopTitle("Today");
  renderAll();
}

/* ------------------------- Modal helpers ------------------------- */
function closeAudible(){ document.getElementById("audibleModal").classList.remove("show"); }
</script>
</body>
</html>